name: Terraform Plan

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensures all files are fetched

      - name: Verify Files in Directory
        run: ls -R ./terraform  # Check the contents of the terraform directory for debugging

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.7.5'  # Update to the version you're using

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Terraform Validate
        run: terraform validate -chdir=terraform  # Validate Terraform configuration

      - name: Terraform Init (with Debugging)
        run: |
          TF_LOG=DEBUG terraform init -chdir=terraform  # Initialize Terraform with detailed logs

      - name: Terraform Plan
        run: terraform plan -out=tfplan -chdir=terraform  # Generate plan output

      - name: Upload Terraform Plan as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/tfplan
